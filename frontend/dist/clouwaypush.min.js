/**
 * clouwaypush - 2017-11-02
 *
 * Copyright (c) 2017 clouWay ltd
 */
!function(a,b,c){b.module("clouway-push",[]).provider("pushApi",function(){this.endpoints={serviceUrl:""},this.backendServiceUrl=function(a){return this.endpoints.serviceUrl=a,this},this.$get=["$rootScope","$timeout","$http","$q",function(a,c,d,e){function f(b,c,d,e){d||(d="");var f=c+d,g=function(b){e(b),a.$apply()};return b.push({eventKey:f,eventName:c,handler:g}),g}function g(a){if(a.length){var c=[];b.forEach(a,function(a){var b=a.eventKey;b in j||(j[b]=[],c.push({eventKey:b,eventName:a.eventName})),j[b].push(a.handler)}),a.splice(0,a.length),r(c)}}var h,i=this.endpoints,j={},k=[],l=[],m={},n={},o="",p=function(a){var c=b.fromJson(a),d=c.event,e=[d.key,c.correlationId].join(""),f=j[e];b.forEach(f,function(a){a(d)})},q=function(a){return firebase.auth().signInWithCustomToken(a.token).then(function(){o=a.namespace})},r=function(a){i.serviceUrl&&""!==i.serviceUrl&&a.length&&m.openConnection().then(function(){n=firebase.database().ref(o),b.forEach(a,function(a){var b=n.child(a.eventName),c=!0;b.once("value",function(){c=!1}),b.on("child_added",function(a){c||p(a.val())}),b.on("child_changed",function(a){p(a.val())})})})},s=function(a){i.serviceUrl&&""!==i.serviceUrl&&n.child(a).off()};return m.openConnection=function(){return o?e.resolve():d.get(i.serviceUrl).then(function(a){return q(a.data)})},m.fireSpecificEvent=function(a,c,d){var e=b.extend({key:a},d),f={correlationId:c,event:e};p(f)},m.fireEvent=function(a,b){m.fireSpecificEvent(a,"",b)},m.bind=function(a,b){return m.bindId(a,"",b)},m.bindId=function(a,b,c){var d=[],e=f(d,a,b,c);return l.length?l.push(d[0]):g(d),e},m.bulkBind=function(a,b){return m.bulkBindId(a,"",b)},m.bulkBindId=function(a,b,c){return f(k,a,b,c)},m.flushBulkBind=function(){l.length||g(k)},m.initialBind=function(a,b){return m.initialBindId(a,"",b)},m.initialBindId=function(a,d,e){var i=f(l,a,d,e);return b.isUndefined(h)&&(h=c(function(){g(l.concat(k)),l.splice(0,l.length),k.splice(0,k.length)})),i},m.isBulkBindPending=function(){return k.length>0},m.unbind=function(a,b){m.unbindId(a,"",b)},m.unbindId=function(a,c,d){c||(c="");var e=a+c;if(e in j){if(b.isUndefined(d))return s(a,c),void delete j[e];var f=j[e].indexOf(d);0>f||(j[e].splice(f,1),j[e].length||(s(a,c),delete j[e]))}},m}]}).config(["pushApiProvider",function(a){var b="/v1/pushService/token";a.backendServiceUrl(b)}]).directive("pushHandler",["$parse","pushApi",function(a,b){return{restrict:"E",link:function(c,d,e){var f=e.event,g=a(e.correlationId)(c),h=a(e.onEvent);d.remove();var i=b.bindId(f,g,function(a){h(c,{$event:a})});c.$on("$destroy",function(){b.unbindId(f,g,i)})}}}])}(window,window.angular);