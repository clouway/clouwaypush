/**
 * clouwaypush - 2016-03-08
 *
 * Copyright (c) 2016 clouWay ltd
 */
!function(a,b,c){b.module("clouway-push",[]).provider("pushApi",function(){this.subscriberLength=15,this.endpoints={serviceUrl:""},this.timeIntervals={keepAlive:60,channelReconnect:5},this.backendServiceUrl=function(a){return this.endpoints.serviceUrl=a,this},this.keepAliveTimeInterval=function(a){return this.timeIntervals.keepAlive=a,this},this.reconnectTimeInterval=function(a){return this.timeIntervals.channelReconnect=a,this},this.$get=["$rootScope","$interval","$timeout","$window","$http",function(a,c,d,e,f){function g(b,c,d,e){d||(d="");var f=c+d,g=function(b){e(b),a.$apply()};return b.push({eventKey:f,handler:g}),g}function h(a){if(a.length){var c=[];b.forEach(a,function(a){var b=a.eventKey;b in o||(o[b]=[],c.push(b)),o[b].push(a.handler)}),a.splice(0,a.length),v(c)}}var i,j,k,l=this.subscriberLength,m=this.timeIntervals,n=this.endpoints,o={},p=[],q=[],r={},s=function(a){for(var b="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ123456",c=[],d=0;a>d;){d++;var e=Math.floor(Math.random()*b.length);c.push(b.charAt(e))}return c.join("")},t=function(a){var c=b.fromJson(a.data),d=c.event,e=[d.key,c.correlationId].join(""),f=o[e];b.forEach(f,function(a){a(d)})},u=function(a){var b=new goog.appengine.Channel(a),c=b.open();c.onmessage=t,c.onerror=function(a){y()}},v=function(a){var b=r.openConnection(),c={subscriber:b,eventName:a};n.serviceUrl&&""!==n.serviceUrl&&a.length&&f.put(n.serviceUrl,"",{params:c}).then(function(a){})},w=function(a,b){var c={subscriber:i,eventName:a,correlationId:b};n.serviceUrl&&""!==n.serviceUrl&&f["delete"](n.serviceUrl,{params:c}).then(function(a){})},x=function(){var a={subscriber:i};f.post(n.serviceUrl,"",{params:a}).then(function(a){})},y=function(){var a={subscriber:i};f.get(n.serviceUrl,{params:a}).then(function(a){u(a.data),j||(j=c(x,1e3*m.keepAlive))},function(){d(y,1e3*m.channelReconnect,!0)})};return r.openConnection=function(a){return i?i:(a||(a=s(l)),i=a,y(a),a)},r.fireSpecificEvent=function(a,c,d){var e=b.extend({key:a},d),f={correlationId:c,event:e};t({data:f})},r.fireEvent=function(a,b){r.fireSpecificEvent(a,"",b)},r.bind=function(a,b){return r.bindId(a,"",b)},r.bindId=function(a,b,c){var d=[],e=g(d,a,b,c);return q.length?q.push(d[0]):h(d),e},r.bulkBind=function(a,b){return r.bulkBindId(a,"",b)},r.bulkBindId=function(a,b,c){return g(p,a,b,c)},r.flushBulkBind=function(){q.length||h(p)},r.initialBind=function(a,b){return r.initialBindId(a,"",b)},r.initialBindId=function(a,c,e){var f=g(q,a,c,e);return b.isUndefined(k)&&(k=d(function(){h(q.concat(p)),q.splice(0,q.length),p.splice(0,p.length)})),f},r.isBulkBindPending=function(){return p.length>0},r.unbind=function(a,b){r.unbindId(a,"",b)},r.unbindId=function(a,c,d){c||(c="");var e=a+c;if(e in o){if(b.isUndefined(d))return w(a,c),void delete o[e];var f=o[e].indexOf(d);0>f||(o[e].splice(f,1),o[e].length||(w(a,c),delete o[e]))}},r}]}).config(["pushApiProvider",function(a){var b="/pushService",c=30,d=10;a.backendServiceUrl(b).keepAliveTimeInterval(c).reconnectTimeInterval(d)}])}(window,window.angular);